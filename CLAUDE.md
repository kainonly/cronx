# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Cronx is a cron node service built with Go that provides HTTP APIs for managing distributed cron schedulers and jobs. It allows creating schedulers with timezone support, adding HTTP-based jobs with cron expressions, and logging execution results to VictoriaLogs.

## Build and Run Commands

```bash
# Build the project
go build -o cronx .

# Run the application
go run main.go

# The application expects a config file at ./config/values.yml
# Copy the example config first:
cp config/values.example.yml config/values.yml

# Regenerate Wire dependency injection code (after modifying bootstrap/wire.go)
cd bootstrap && wire
```

## Architecture

### Dependency Injection with Wire

The project uses [Google Wire](https://github.com/google/wire) for compile-time dependency injection:

- [bootstrap/wire.go](bootstrap/wire.go) - Wire configuration with `//go:build wireinject` tag
- [bootstrap/wire_gen.go](bootstrap/wire_gen.go) - Auto-generated by Wire (do not edit manually)
- [bootstrap/bootstrap.go](bootstrap/bootstrap.go) - Provider functions for dependencies (UseGorm, UsePassport, UseHertz, etc.)

When adding new dependencies or modifying providers, run `wire` in the bootstrap directory to regenerate wire_gen.go.

### Core Components

**common package** - Shared types and utilities:
- `Values` - Configuration structure loaded from YAML
- `Inject` - Common dependencies injected into services (DB, Logs, Cron)
- `Scheduler` & `Job` - Core domain models with validation tags
- `Cronx` - Thread-safe sync.Map wrapper for managing gocron.Scheduler instances
- `Victorialogs` - Client for pushing execution logs to VictoriaLogs
- `FindDto` - Standard pagination/search DTO with helpers for offset/limit/keyword

**bootstrap package** - Application initialization:
- Loads YAML configuration from `config/values.yml`
- Sets up Gorm (SQLite), VictoriaLogs client, Passport (JWT), and Hertz server
- Uses Wire for dependency injection

**api package** - HTTP API layer using Cloudwego Hertz:
- [api/api.go](api/api.go) - Routes configuration in `Initialize()` method
- [api/auth.go](api/auth.go) - Bearer token authentication middleware
- Structured as Controller → Service pattern:
  - **Controller**: HTTP request/response handling, validation (`BindAndValidate`)
  - **Service**: Business logic, database operations, cron management

### API Structure

Controllers follow this pattern:
```go
type Controller struct {
    V *common.Values      // Configuration
    ServiceX *Service     // Service layer
}

type Service struct {
    *common.Inject        // Injected dependencies (Db, Logs, Cron)
}
```

Each API module (index, jobs, schedulers) uses Wire's `Provides` set to register both Controller and Service.

### Key Endpoints

- `GET /` - Ping endpoint
- **Jobs** (`/jobs`):
  - `POST /jobs/set` - Add/update job to scheduler
  - `POST /jobs/remove` - Remove job from scheduler
- **Schedulers** (`/schedulers`):
  - `GET /schedulers` - List all schedulers (with pagination)
  - `POST /schedulers/set` - Create/update scheduler with jobs
  - `POST /schedulers/start` - Start a scheduler
  - `POST /schedulers/stop` - Stop a scheduler
  - `POST /schedulers/remove` - Remove a scheduler

### Data Flow

1. HTTP request → Auth middleware checks Bearer token
2. Controller binds/validates request → DTO with `vd` validation tags
3. Service executes business logic:
   - Manages gocron.Scheduler instances in `Cronx` sync.Map
   - Persists scheduler configs to Gorm/SQLite
   - Job execution triggers HTTP requests via resty client
4. Job results pushed to VictoriaLogs for observability

### Validation

Uses Hertz with go-playground validator:
- Validation tag: `vd` (not the default `validate`)
- Common validations: `uuid4`, `cron`, `timezone`, `url`, `oneof`
- Configured in [bootstrap/bootstrap.go:71-72](bootstrap/bootstrap.go#L71-L72)

### Database

Currently using Gorm with SQLite driver, but note:
- Many service methods have commented-out BadgerDB code
- The codebase is transitioning from BadgerDB to Gorm
- SQLite connection is configured as in-memory: `sqlite.Open("")` at [bootstrap/bootstrap.go:35](bootstrap/bootstrap.go#L35)

### Error Handling

Uses `github.com/kainonly/go/help` package:
- `help.E(code, message)` for creating errors
- `help.Ok()` for successful responses
- `help.ErrorHandler()` middleware for consistent error formatting

## Configuration

Config file structure (config/values.yml):
```yaml
address: :9000                # Hertz server address
node: dev                      # Node identifier (JWT issuer)
key: <secret>                  # JWT signing key
domain: localhost:9000         # Service domain
origins:                       # CORS allowed origins
  - http://localhost:4200
database:
  path: ./db/                  # Database path (currently unused with in-memory SQLite)
  victorialogs: http://...     # VictoriaLogs endpoint for job execution logs
```

## Development Notes

- The scheduler service ([api/schedulers/set.go](api/schedulers/set.go)) has most logic commented out, suggesting active development
- Jobs execute HTTP requests with configurable method, headers, query params, body, and basic auth
- Execution logs (duration, status, response body) are pushed to VictoriaLogs with `scheduler_key` and `job_id` as stream fields
- No test files currently exist in the repository
